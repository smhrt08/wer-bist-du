<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>wer bist du</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, sans-serif;
      background: #f1f5f9;
      padding: 2rem;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .header {
      text-align: center;
      margin-bottom: 2rem;
    }
    .header h1 {
      font-size: 2rem;
      font-weight: 700;
      color: #1e293b;
    }
    .header p { color: #64748b; margin-bottom: 1rem; }

    .btn-primary {
      background: #2563eb;
      color: white;
      border: none;
      border-radius: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-weight: 500;
      cursor: pointer;
    }
    .btn-primary:disabled { background: #cbd5e1; cursor: not-allowed; }

    .video-row {
      display: flex;
      gap: 1.5rem;
    }
    .card {
      flex: 1;
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 1rem;
    }
    .video-container {
      position: relative;
      background: #0f172a;
      border-radius: 0.75rem;
      overflow: hidden;
      aspect-ratio: 16/9;
    }
    video, canvas {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    .controls {
      margin-top: 1rem;
      display: flex;
      gap: 1rem;
      justify-content: space-between;
    }
    .toggle {
      position: relative;
      width: 3rem;
      height: 1.5rem;
      background: #cbd5e1;
      border-radius: 1rem;
      cursor: pointer;
      transition: background 0.3s;
    }
    .toggle.active { background: #2563eb; }
    .toggle-slider {
      position: absolute;
      top: 0.2rem;
      left: 0.2rem;
      width: 1.1rem;
      height: 1.1rem;
      background: white;
      border-radius: 50%;
      transition: transform 0.3s;
    }
    .toggle.active .toggle-slider { transform: translateX(1.4rem); }

    .debug-panel {
      background: white;
      border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      padding: 1rem;
      margin-top: 1.5rem;
    }
    .debug-panel h2 {
      color: #1e293b;
      font-size: 1.2rem;
      margin-bottom: 0.5rem;
    }
    .debug-log {
      height: 18rem;
      overflow-y: auto;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 0.5rem;
      padding: 0.5rem;
      font-family: monospace;
      font-size: 0.8rem;
      color: #334155;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>wer bist du</h1>
      <p>v6.000</p>
      <button id="startBtn" class="btn-primary">Start Camera</button>
    </div>

    <div class="video-row">
      <!-- Left: Face Detection -->
      <div class="card">
        <h3 style="margin-bottom:0.5rem; color:#1e3a8a;">Face Detection View</h3>
        <div class="video-container">
          <video id="videoLeft" autoplay muted playsinline></video>
          <canvas id="canvasFaces"></canvas>
        </div>
      </div>

      <!-- Right: Background Isolation -->
      <div class="card">
        <h3 style="margin-bottom:0.5rem; color:#1e3a8a;">Background Isolation View</h3>
        <div class="video-container">
          <video id="videoRight" autoplay muted playsinline></video>
          <canvas id="canvasBG" class="hidden"></canvas>
        </div>
        <div class="controls">
          <div id="bgToggle" class="toggle"><div class="toggle-slider"></div></div>
          <div id="ghostToggle" class="toggle"><div class="toggle-slider"></div></div>
        </div>
      </div>
    </div>

    <!-- Debug below -->
    <div class="debug-panel">
      <h2>Debug Log</h2>
      <div id="debugLog" class="debug-log"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/selfie_segmentation.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_detection"></script>

  <script>
    const startBtn = document.getElementById('startBtn');
    const videoLeft = document.getElementById('videoLeft');
    const videoRight = document.getElementById('videoRight');
    const canvasFaces = document.getElementById('canvasFaces');
    const canvasBG = document.getElementById('canvasBG');
    const bgToggle = document.getElementById('bgToggle');
    const ghostToggle = document.getElementById('ghostToggle');
    const debugLog = document.getElementById('debugLog');

    let stream = null;
    let virtualBgEnabled = false;
    let ghostModeEnabled = false;
    let selfieSegmentation = null;
    let faceDetector = null;

    function log(msg) {
      const t = new Date().toLocaleTimeString();
      debugLog.innerHTML += `[${t}] ${msg}<br>`;
      debugLog.scrollTop = debugLog.scrollHeight;
    }

    async function startCamera() {
      try {
        startBtn.disabled = true;
        log('Requesting camera...');
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 1280, height: 720 },
          audio: false
        });
        videoLeft.srcObject = stream;
        videoRight.srcObject = stream;
        log('âœ“ Camera started on both feeds.');
        await initMediaPipe();
      } catch (err) {
        log('Camera error: ' + err.message);
      }
    }

    async function initMediaPipe() {
      selfieSegmentation = new SelfieSegmentation({
        locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/selfie_segmentation/${f}`
      });
      selfieSegmentation.setOptions({ modelSelection: 1 });

      faceDetector = new FaceDetection.FaceDetection({
        locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_detection/${f}`
      });
      faceDetector.setOptions({ model: 'short', minDetectionConfidence: 0.6 });

      const camera = new Camera(videoLeft, {
        onFrame: async () => {
          await faceDetector.send({ image: videoLeft });
          if (virtualBgEnabled)
            await selfieSegmentation.send({ image: videoRight });
        },
        width: 1280,
        height: 720
      });

      faceDetector.onResults(onFaceResults);
      selfieSegmentation.onResults(onSegmentationResults);
      await camera.start();
      log('MediaPipe initialized.');
    }

    function onFaceResults(results) {
      const ctx = canvasFaces.getContext('2d');
      ctx.clearRect(0, 0, canvasFaces.width, canvasFaces.height);
      canvasFaces.width = videoLeft.videoWidth;
      canvasFaces.height = videoLeft.videoHeight;
      ctx.drawImage(videoLeft, 0, 0, canvasFaces.width, canvasFaces.height);
      if (!results.detections) return;
      results.detections.forEach(det => {
        const box = det.boundingBox;
        ctx.strokeStyle = '#00bfff';
        ctx.lineWidth = 3;
        ctx.strokeRect(
          box.xCenter * canvasFaces.width - (box.width * canvasFaces.width) / 2,
          box.yCenter * canvasFaces.height - (box.height * canvasFaces.height) / 2,
          box.width * canvasFaces.width,
          box.height * canvasFaces.height
        );
      });
    }

    function onSegmentationResults(results) {
      const ctx = canvasBG.getContext('2d');
      canvasBG.width = videoRight.videoWidth;
      canvasBG.height = videoRight.videoHeight;

      ctx.clearRect(0, 0, canvasBG.width, canvasBG.height);
      ctx.fillStyle = '#1e3a8a';
      ctx.fillRect(0, 0, canvasBG.width, canvasBG.height);

      if (!results.segmentationMask) return;
      const mask = results.segmentationMask;
      ctx.save();
      ctx.drawImage(mask, 0, 0, canvasBG.width, canvasBG.height);
      ctx.globalCompositeOperation = 'source-in';
      ctx.drawImage(videoRight, 0, 0, canvasBG.width, canvasBG.height);
      ctx.restore();
    }

    bgToggle.onclick = async () => {
      virtualBgEnabled = !virtualBgEnabled;
      bgToggle.classList.toggle('active', virtualBgEnabled);
      if (virtualBgEnabled) {
        canvasBG.classList.remove('hidden');
        videoRight.classList.add('hidden');
        log('Virtual background enabled.');
      } else {
        canvasBG.classList.add('hidden');
        videoRight.classList.remove('hidden');
        log('Virtual background disabled.');
      }
    };

    ghostToggle.onclick = () => {
      ghostModeEnabled = !ghostModeEnabled;
      ghostToggle.classList.toggle('active', ghostModeEnabled);
      log(ghostModeEnabled ? 'Ghost mode enabled.' : 'Ghost mode disabled.');
    };

    startBtn.onclick = startCamera;
  </script>
</body>
</html>
