<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hackathon Prototype - Face & Audio Awareness</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; margin: 20px; }
    video { border: 2px solid #333; border-radius: 8px; }
    .toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 16px;
    }
    .toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from { bottom: 0; opacity: 0; } to { bottom: 30px; opacity: 1; } }
    @keyframes fadeout { from { bottom: 30px; opacity: 1; } to { bottom: 0; opacity: 0; } }
    #debug { margin-top: 20px; font-size: 14px; text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; }
  </style>
</head>
<body>
  <h1>wer bist du</h1>
  <h3>v3.000</h3>
  <video id="video" width="480" height="360" autoplay muted></video>

  <!-- Toasts -->
  <div id="faceToast" class="toast">⚠️ More than one face detected!</div>
  <div id="lightToast" class="toast" style="background-color: #ff9800;">⚠️ Low light detected!</div>
  <div id="snrToast" class="toast" style="background-color: #e91e63;">⚠️ Background noise too high!</div>
  <div id="headToast" class="toast" style="background-color: #007bff;">⚠️ Adjust your posture — head tilt or slouch detected!</div>

  <h3>Debug Log</h3>
  <div id="debug"></div>

  <!-- Face API -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>

  <script>
    const video = document.getElementById('video');
    const faceToast = document.getElementById("faceToast");
    const lightToast = document.getElementById("lightToast");
    const snrToast = document.getElementById("snrToast");
    const headToast = document.getElementById("headToast");
    const debugLog = document.getElementById("debug");

    function showToast(el) {
      el.className = "toast show";
      setTimeout(() => { el.className = el.className.replace("show", ""); }, 3000);
    }

    function addDebug(msg) {
      const now = new Date().toLocaleTimeString();
      debugLog.innerHTML = `<div>[${now}] ${msg}</div>` + debugLog.innerHTML;
    }

    async function initialize() {
      await Promise.all([
        faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights'),
        faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/weights')
      ]);

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        video.srcObject = stream;
        addDebug("✓ Camera and mic access granted");
        startFaceDetection();
        startAudioSNRLogging(stream);
      } catch (err) {
        addDebug("Error accessing media devices: " + err.message);
      }
    }

    async function startFaceDetection() {
      const options = new faceapi.TinyFaceDetectorOptions();
      setInterval(async () => {
        const detections = await faceapi
          .detectAllFaces(video, options)
          .withFaceLandmarks();

        if (detections.length > 1) {
          showToast(faceToast);
          addDebug(`Multiple faces detected: ${detections.length}`);
        }

        if (detections.length > 0) {
          const landmarks = detections[0].landmarks;

          // posture checks
          const leftEye = landmarks.getLeftEye()[0];
          const rightEye = landmarks.getRightEye()[3];
          const nose = landmarks.getNose()[3];

          const eyeTilt = Math.abs(leftEye.y - rightEye.y);
          const eyeCenterY = (leftEye.y + rightEye.y) / 2;
          const noseForward = nose.y - eyeCenterY;

          const tiltThreshold = 15;   // adjust for camera
          const forwardThreshold = 10;

          if (eyeTilt > tiltThreshold || noseForward > forwardThreshold) {
            showToast(headToast);
            addDebug(`Posture alert: tilt=${eyeTilt.toFixed(1)}, forward=${noseForward.toFixed(1)}`);
          }
        }

        // Low light check
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const frame = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const avgBrightness = frame.data.reduce((a, b, i) => i % 4 === 0 ? a + b : a, 0) / (frame.data.length / 4);
        if (avgBrightness < 40) {
          showToast(lightToast);
          addDebug(`Low light detected: brightness=${avgBrightness.toFixed(1)}`);
        }

      }, 1500);
    }

    async function startAudioSNRLogging(stream) {
      const audioCtx = new AudioContext();
      const source = audioCtx.createMediaStreamSource(stream);
      const analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      source.connect(analyser);

      const dataArray = new Float32Array(analyser.fftSize);

      function computeSNR() {
        analyser.getFloatTimeDomainData(dataArray);

        let signalPower = 0;
        for (let i = 0; i < dataArray.length; i++) {
          signalPower += dataArray[i] * dataArray[i];
        }
        signalPower /= dataArray.length;

        const sorted = [...dataArray].map(Math.abs).sort((a, b) => a - b);
        const noiseSlice = sorted.slice(0, Math.floor(sorted.length * 0.1));
        let noisePower = noiseSlice.reduce((sum, v) => sum + v * v, 0) / noiseSlice.length;
        if (noisePower <= 0) noisePower = 1e-10;

        const snrDb = 10 * Math.log10(signalPower / noisePower);

        addDebug(`Audio SNR: ${snrDb.toFixed(2)} dB`);

        if (snrDb < 10) {
          showToast(snrToast);
        }
      }

      setInterval(computeSNR, 1000);
      addDebug("✓ Audio SNR logging started");
    }

    initialize();
  </script>
</body>
</html>
